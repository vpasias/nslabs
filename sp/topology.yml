#
# This topology combines SR-MPLS topology with IBGP session between AS-edge devices
# and EBGP sessions with two external routers, using SR Linux 7250 IXR devices
#
# BGP-free core based on Segment Routing
#

provider: clab
#defaults.devices.linux.clab.node.kind: bridge

name: sp

addressing:
  loopback:
    ipv4: 10.255.255.0/24
    ipv6: 2001:db8:0::/48
  lan:
    ipv4: 172.16.0.0/16
    ipv6: 2001:db8:1::/48
  p2p:
    ipv4: 10.250.0.0/16
    ipv6: 2001:db8:2::/48
  mgmt:
    ipv4: 192.168.121.0/24
    start: 100
    mac: 08-4F-A9-00-00-00

defaults:
  device: srlinux
  sr.extra_attributes.global: [ srgb_range_start, srgb_range_size ]
#  bridge_type: ovs-bridge
  providers:
    clab:
      devices:
        srlinux:
          provider_type: ixr6 # SR-MPLS only supported on 7250 IXR platform
        
# SR Global Block label range
sr.srgb_range_start: 500000
sr.srgb_range_size: 1000

vlans:
  red:
    mode: bridge
  blue:
    mode: bridge

groups:
  core:
    members: [ a1,a2,a3,a4 ]
    module: [ isis,sr,bfd ]
  aggr:
    members: [ b1,b2,b3,b4,b5,b6 ]   
    module: [ isis,sr,bfd ]
  edge:
    members: [ e1,e2,e3,e4 ] 
    module: [ isis, bgp, sr, bfd ]
    node_data:
      bgp.as: 65000 
  spines:
    members: [ c1,c2 ]
    module: [ isis,bgp,evpn ]
    device: frr
    node_data:
      bgp.rr: True
      bgp.as: 64999
  leaves:
    members: [ d1,d2 ]
    module: [ vlan,vxlan,isis,bgp,evpn ]
    device: frr
    node_data:
      bgp.as: 64999
  hosts:
    members: [ n1,n2,n3,n4 ]
    device: linux
  external:
    members: [ x1,x2,x3,x4 ] 
    module: [ bgp, bfd ]

nodes:
  # CORE (no BGP)
  a1:
  a2:
  a3:
  a4:

  # AGGREGATION (no BGP)
  b1:
  b2:
  b3:
  b4:
  b5:
  b6:

  # EDGE
  e1:
  e2:
  e3:
  e4:

  # SPINE
  c1:
  c2:

  # LEAF
  d1:
  d2:

  # HOST
  n1:
  n2:
  n3:
  n4:

  # EXTERNAL PEERS
  x1:
    bgp:
      as: 65001
  x2:
    bgp:
      as: 65002
  x3:
    bgp:
      as: 65003
  x4:
    bgp:
      as: 65004

links:
# Core layer links
- a1-a2
- a1-a3
- a2-a4
- a3-a4
- a1-a4
- a2-a3

# Aggregation layer links
- b1-a1
- b1-a2
- b2-a1
- b2-a2
- b1-b2
- b3-a3
- b3-a4
- b4-a3
- b4-a4
- b3-b4
- b5-a1
- b5-a3
- b6-a1
- b6-a3
- b5-b6

# Edge layer links
- e1-b1
- e1-b2
- e2-b1
- e2-b2
- e3-b3
- e3-b4
- e4-b3
- e4-b4
- c1-b1
- c1-b2
- c2-b1
- c2-b2

# External links
- x1-e1
- x2-e2
- x3-e3
- x4-e4

# DC links
- n1:
  d1:
    vlan.access: red
- n2:
  d2:
    vlan.access: red
- n3:
  d1:
    vlan.access: blue
- n4:
  d2:
    vlan.access: blue
- d1-c1
- d1-c2
- d2-c1
- d2-c2

# Stub links
- x1
- x2
- x3
- x4
